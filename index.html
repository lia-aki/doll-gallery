<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã†ã¡ã®å­å±•ç¤ºå®¤ | My Doll Brand Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap');
        body { 
            background-color: #fff9fa; 
            color: #5a5255; 
            font-family: 'Noto Sans JP', sans-serif; 
            margin: 0;
        }
        .masonry { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            grid-gap: 20px; 
            grid-auto-flow: dense; 
        }
        .masonry-item { 
            background: white; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 10px 20px rgba(255, 182, 193, 0.15); 
            transition: transform 0.3s ease;
        }
        .masonry-item:hover { transform: translateY(-5px); }
        .loading-spinner { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #ff9a9e; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            animation: spin 1s linear infinite; 
            display: none; 
            margin: 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* æŠ½å¥–å®¹å™¨ï¼šå…¨å±é€æ˜ï¼ŒèƒŒæ™¯æ¨¡ç³Š */
	#lottery-stage {
	    position: fixed;
	    inset: 0;
	    z-index: 9999; /* å¿…é¡»æ˜¯æœ€å¤§ï¼Œç¡®ä¿ç›–åœ¨å›¾ç‰‡å¢™ä¸Š */
	    background: rgba(0, 0, 0, 0.75); /* æ·±è‰²é€æ˜èƒŒæ™¯ï¼Œçªå‡ºä¸­å¥–å›¾ */
	    backdrop-filter: blur(8px); /* èƒŒæ™¯æ¨¡ç³Šæ„Ÿ */
	    display: none; /* åˆå§‹éšè— */
	    align-items: center;
	    justify-content: center;
	}

	.vortex-item {
	    position: absolute;
	    width: 140px;
	    height: 140px;
	    object-fit: cover;
	    border-radius: 15px;
	    transition: all 2.5s cubic-bezier(0.19, 1, 0.22, 1);
	    pointer-events: none; /* é˜²æ­¢é®æŒ¡ç‚¹å‡»äº‹ä»¶ */
	}

	.winner-final {
	    /* æœ€ç»ˆå®šæ ¼ä½ç½®å¼ºåˆ¶åœ¨ä¸­å¿ƒ */
	    left: 50% !important;
	    top: 45% !important;
	    transform: translate(-50%, -50%) scale(2.2) !important;
	    z-index: 10000;
	    border: 6px solid #ff9a9e;
	    box-shadow: 0 0 50px rgba(255, 154, 158, 0.8);
	}
    </style>
</head>
<body class="p-4 md:p-10">
	<div id="lottery-stage">
	    <div id="winner-text" class="absolute bottom-20 w-full text-center opacity-0 transition-opacity duration-1000" style="z-index: 10001;">
	        <h2 class="text-3xl font-bold text-white mb-2">ğŸ‰ ã”å½“é¸ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ‰</h2>
	        <p id="winner-id-display" class="text-xl text-pink-300 font-bold mb-6"></p>
	        <button onclick="closeLottery()" class="px-10 py-3 bg-pink-500 text-white rounded-full font-bold shadow-lg hover:bg-pink-600 transition">
	            é–‰ã˜ã‚‹
	        </button>
	    </div>
	</div>
    <header class="text-center mb-10">
        <h1 class="text-3xl font-bold text-[#d87a80] mb-2">ã†ã¡ã®å­å±•ç¤ºå®¤</h1>
        <p class="text-xs text-gray-400 tracking-widest uppercase">RosenliaDoll Photo Gallery</p>
    </header>

    <section id="upload-section" class="max-w-xl mx-auto mb-16 bg-white border border-pink-100 rounded-3xl p-8 shadow-sm">
        <div class="text-center">
            <h2 class="text-lg font-bold text-pink-600 mb-4">âœ¨ ãƒ•ã‚©ãƒˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿæ–½ä¸­ âœ¨</h2>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">
                ãŠå†™çœŸã‚’æŠ•ç¨¿ã„ãŸã ã„ãŸæ–¹ã®ä¸­ã‹ã‚‰ã€æ¯æœˆæŠ½é¸ã§<br>
                æ–°ä½œã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã„ãŸã—ã¾ã™ã€‚
            </p>
            
            <div class="space-y-4">
                <input type="text" id="twitter_id" placeholder="X (Twitter) ID (@ãªã—)" 
                       class="w-full border-b-2 border-pink-50 py-2 px-4 focus:outline-none focus:border-pink-300 text-center">
                
                <input type="file" id="file_input" accept="image/*" class="hidden">
                <button onclick="document.getElementById('file_input').click()" 
                        class="w-full bg-pink-400 hover:bg-pink-500 text-white font-bold py-3 rounded-full shadow-lg transition duration-300">
                    å†™çœŸã‚’æŠ•ç¨¿ã™ã‚‹
                </button>
                
                <div id="loader" class="loading-spinner"></div>
                <div id="status" class="text-xs text-pink-400 mt-2"></div>
                <p class="text-[10px] text-gray-400 mt-4">
                    â€»æŠ•ç¨¿ã•ã‚ŒãŸå†™çœŸã¯é‹å–¶ã®æ‰¿èªå¾Œã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
                    â€»å¤§ããªç”»åƒã¯è‡ªå‹•çš„ã«æœ€é©åŒ–ï¼ˆåœ§ç¸®ï¼‰ã•ã‚Œã¾ã™ã€‚
                </p>
            </div>
        </div>
    </section>

    <div id="gallery" class="masonry max-w-7xl mx-auto">
        </div>

    <footer class="mt-20 py-10 border-t border-pink-50 text-center text-gray-400 text-[10px]">
        <p>&copy; 2026 RosenliaDoll. All Rights Reserved.</p>
    </footer>

    <script>
        // --- è¨­å®šã‚¨ãƒªã‚¢ (ã“ã“ã‚’ã‚ãªãŸã®æƒ…å ±ã«æ›¸ãæ›ãˆã¦ãã ã•ã„) ---
        const SB_URL = 'https://eiladnaqqcddtkfqypvb.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbGFkbmFxcWNkZHRrZnF5cHZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTI1MjAsImV4cCI6MjA4NjkyODUyMH0.ypTl6LS3wvjc_24-eCNOxvvZVOAQ6F_PGhoXfHWW8pY'; // æ­¤å¤„æ›¿æ¢ä¸ºä½ çš„ Anon Key
        const myAppClient = supabase.createClient(SB_URL, SB_KEY);

        const fileInput = document.getElementById('file_input');
        const statusText = document.getElementById('status');
        const loader = document.getElementById('loader');
        const twitterInput = document.getElementById('twitter_id');

		// æŠ•ç¨¿ã§ãã‚‹ã‹ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
		async function checkUploadStatus() {
		    const { data, error } = await myAppClient
		        .from('settings')
		        .select('value')
		        .eq('key', 'is_upload_enabled')
		        .single();

		    const uploadSection = document.getElementById('upload-section');

		    if (data && data.value === false) {
		        uploadSection.style.display = 'none';
		    } else {
		        uploadSection.style.display = 'block';
		    }
		}

        // 1. ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ (Load Photos)
        async function loadPhotos() {
        
            const { data, error } = await myAppClient
                .from('gallery')
                .select('*')
                .eq('is_approved', true) // æ‰¿èªæ¸ˆã¿ã®ã¿
                .order('created_at', { ascending: false });

            if (data) {
                const galleryDiv = document.getElementById('gallery');
                galleryDiv.innerHTML = data.map(item => `
                    <div class="masonry-item">
                        <img src="${item.url}" class="w-full h-auto block" loading="lazy">
                        <div class="p-3 flex justify-between items-center bg-white">
                            <span class="text-[10px] font-bold text-gray-400">Owner: @${item.twitter_id || 'åŒ¿å'}</span>
                            <span class="text-[9px] text-gray-300">${item.file_size ? item.file_size + 'KB' : ''}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // 2. ç”»åƒåœ§ç¸®ãƒ­ã‚¸ãƒƒã‚¯ (Image Compression)
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200; // å±•ç¤ºç”¨ã«ã¯1200pxã§ååˆ†
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.8); // 80%ã®ç”»è³ªã§åœ§ç¸®
                    };
                };
            });
        };

        // 3. æŠ•ç¨¿å‡¦ç† (Upload Logic)
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            loader.style.display = 'block';
            statusText.innerText = 'ç”»åƒã‚’æœ€é©åŒ–ä¸­...';

            try {
                // A. åœ§ç¸®
                const compressedBlob = await compressImage(file);
                const fileSizeKB = (compressedBlob.size / 1024).toFixed(1);
                const fileName = `${Date.now()}.jpg`;

                statusText.innerText = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

                // B. Storageã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const { data: uploadData, error: uploadError } = await myAppClient.storage
                    .from('photos')
                    .upload(fileName, compressedBlob);

                if (uploadError) throw uploadError;

                // C. å…¬é–‹URLå–å¾—
                const { data: urlData } = myAppClient.storage.from('photos').getPublicUrl(fileName);

                // D. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ç™»éŒ²
                const twitterId = twitterInput.value || 'Anonymous';
                const { error: dbError } = await myAppClient.from('gallery').insert([
                    { 
                        url: urlData.publicUrl, 
                        twitter_id: twitterId, 
                        is_approved: false,
                        file_size: fileSizeKB 
                    }
                ]);

                if (dbError) throw dbError;

                statusText.innerText = 'æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚';
                twitterInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            } catch (err) {
                console.error(err);
                statusText.innerText = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (err.message || 'é€šä¿¡å¤±æ•—');
            } finally {
                loader.style.display = 'none';
            }
        };
        
        // --- æŠ½é¸æ©Ÿèƒ½ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---

		// 1. ä¸­é¸è€…ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹
		async function checkLottery() {
		    // ã€å…³é”®ç‚¹1ã€‘æ£€æŸ¥æµè§ˆå™¨ç¼“å­˜ï¼Œå¦‚æœæœ¬è½®ä¼šè¯å·²çœ‹è¿‡ï¼Œç›´æ¥æ‹¦æˆªï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘
		    if (sessionStorage.getItem('lottery_viewed') === 'true') {
		        console.log("æŠ½å¥–åŠ¨ç”»æœ¬è½®å·²æ’­æ”¾è¿‡ï¼Œè·³è¿‡");
		        return;
		    }

		    // ã€å…³é”®ç‚¹2ã€‘åªè·å– flag ä¸º true çš„æœ€æ–°ä¸­å¥–ä¿¡æ¯
		    const { data, error } = await myAppClient
		        .from('lottery_results')
		        .select('*')
		        .eq('flag', true) // ä»…ç­›é€‰ä¸­å¥–è€…
		        .order('draw_time', { ascending: false })
		        .limit(1)
		        .single();

		    if (data) {
		        // åªæœ‰å­˜åœ¨ true çš„æ•°æ®ä¸”ç¬¦åˆæ—¶é—´è¦æ±‚ï¼ˆå¯é€‰ï¼‰æ‰æ’­æ”¾
		        console.log("å‘ç°ä¸­å¥–è€…ï¼Œå‡†å¤‡æ’­æ”¾åŠ¨ç”»:", data);
		        startVortexAnimation(data);
		    }
		}

	async function startVortexAnimation(winnerData) {
	    const stage = document.getElementById('lottery-stage');
	    if (!stage) return;

	    // å¼ºåˆ¶æ˜¾ç¤ºèˆå°
	    stage.style.display = 'block';
	    stage.style.opacity = '1';

	    // è·å–ç´ æï¼ˆç”¨äºæ¼©æ¶¡çš„ç¢ç‰‡ï¼‰
	    const { data: photos } = await myAppClient.from('gallery').select('url').limit(15);
	    const centerX = window.innerWidth / 2;
	    const centerY = window.innerHeight / 2;

	    // æ¸…ç©ºèˆå°ï¼ˆé˜²æ­¢é‡å¤è§¦å‘å¯¼è‡´å¡é¡¿ï¼‰
	    const oldItems = stage.querySelectorAll('.vortex-item');
	    oldItems.forEach(el => el.remove());

	    const items = [];
	    const count = 20; // ç¢ç‰‡æ•°é‡

	    for (let i = 0; i < count; i++) {
	        const img = document.createElement('img');
	        // å¦‚æœæ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™æ˜¯çœŸæ­£çš„ä¸­å¥–å›¾
	        const isWinner = (i === count - 1);
	        img.src = isWinner ? winnerData.winner_url : (photos[i % photos.length]?.url || winnerData.winner_url);
	        img.className = 'vortex-item';
	        
	        // åˆå§‹ä½ç½®ï¼šå±å¹•å¤–çš„åœ†å‘¨
	        const angle = Math.random() * Math.PI * 2;
	        const radius = Math.max(window.innerWidth, window.innerHeight);
	        img.style.left = `${centerX + Math.cos(angle) * radius}px`;
	        img.style.top = `${centerY + Math.sin(angle) * radius}px`;
	        img.style.zIndex = isWinner ? "110" : "105";
	        
	        stage.appendChild(img);
	        items.push({ el: img, isWinner: isWinner });
	    }

	    // å¯åŠ¨åŠ¨ç”»ï¼šå»¶è¿Ÿ 100ms ç¡®ä¿æµè§ˆå™¨å·²æ¸²æŸ“åˆå§‹ä½ç½®
	    setTimeout(() => {
	        items.forEach((item) => {
	            if (item.isWinner) {
	                // ä¸­å¥–å›¾å®šæ ¼ä¸­å¿ƒ
	                item.el.classList.add('winner-final');
	                item.el.style.left = '50%';
	                item.el.style.top = '45%';
	            } else {
	                // æ™®é€šç¢ç‰‡å‘ä¸­å¿ƒæ—‹è½¬å¹¶æ¶ˆå¤±
	                item.el.style.left = `${centerX}px`;
	                item.el.style.top = `${centerY}px`;
	                item.el.style.transform = `rotate(${720 + Math.random() * 1000}deg) scale(0)`;
	                item.el.style.opacity = '0';
	            }
	        });
	        
	        // æ˜¾ç¤ºæ–‡å­—
	        setTimeout(() => {
	            document.getElementById('winner-id-display').innerText = `@${winnerData.winner_twitter} æ§˜`;
	            document.getElementById('winner-text').style.opacity = '1';
	        }, 2000);
	    }, 100);
	}

		function closeLottery() {
		    const stage = document.getElementById('lottery-stage');
		    stage.style.transition = "opacity 0.8s text-center";
		    stage.style.opacity = '0';

		    setTimeout(() => {
		        stage.style.display = 'none';
		        // ã€å…³é”®ç‚¹3ã€‘å†™å…¥ç¼“å­˜æ ‡è®°ï¼Œè¿™æ ·åˆ·æ–°é¡µé¢å checkLottery ç¬¬ä¸€è¡Œå°±ä¼šæ‹¦æˆª
		        sessionStorage.setItem('lottery_viewed', 'true');
		        console.log("å·²æ ‡è®°åŠ¨ç”»ä¸ºçœ‹è¿‡çŠ¶æ€");
		    }, 800);
		}
		checkLottery();
        // åˆæœŸèª­ã¿è¾¼ã¿å®Ÿè¡Œ
        loadPhotos();
        checkUploadStatus();
    </script>
</body>
</html>